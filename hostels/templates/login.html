<button id="connectWallet">Se connecter avec MetaMask</button>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script>
    const connectBtn = document.getElementById('connectWallet');

    connectBtn.addEventListener('click', async () => {
        if (typeof window.ethereum === 'undefined') {
            alert("Installez MetaMask !");
            return;
        }

        const web3 = new Web3(window.ethereum);
        try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const address = accounts[0];

            // Signature (preuve de possession)
            const message = "Connexion Ã  Pilgrimap";
            const signature = await web3.eth.personal.sign(message, address, '');

            // Envoie au backend Django
            const response = await fetch("/wallet-login/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ address, signature })
            });

            const data = await response.json();
            if (data.success) {
                window.location.href = "/";
            } else {
                alert("Erreur d'authentification : " + data.error);
            }
        } catch (error) {
            console.error(error);
        }
    });
</script>

{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h2>Connexion</h2>
  <form method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label for="username" class="form-label">Nom d'utilisateur</label>
      <input type="text" class="form-control" name="username" required>
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Mot de passe</label>
      <input type="password" class="form-control" name="password" required>
    </div>
    <button type="submit" class="btn btn-primary">Se connecter</button>
  </form>
</div>
{% endblock %}